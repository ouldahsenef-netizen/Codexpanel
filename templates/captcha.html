<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ðŸ–• CODEX Security Verification</title>
    <style>
        body {
            background-color: #000;
            color: #00ff41;
            font-family: 'Fira Code', monospace;
            text-align: center;
            padding: 40px;
        }
        .challenge-box {
            background: #111;
            border: 2px solid #00ff41;
            border-radius: 15px;
            display: inline-block;
            padding: 30px 40px;
            margin-top: 50px;
            max-width: 400px;
        }
        input.challenge-input {
            width: 100%;
            font-size: 18px;
            padding: 15px;
            margin-top: 15px;
            background: #000;
            color: #0f0;
            border: 2px solid #00ff41;
            border-radius: 10px;
            text-align: center;
        }
        button.verify-btn {
            margin-top: 20px;
            width: 100%;
            font-size: 18px;
            padding: 15px;
            background: linear-gradient(45deg, #00ff41, #ff0080);
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }
        button.verify-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .error-message {
            margin-top: 20px;
            color: #ff0080;
            font-weight: bold;
        }
        .success-message {
            margin-top: 20px;
            color: #00ff41;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ðŸ–• CODEX Advanced Security System</h1>
    <div class="challenge-box">
        <div id="challenge-question" style="font-size: 22px; font-weight: bold;">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...</div>
        <input type="number" id="answer-input" class="challenge-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡Ù†Ø§..." />
        <button id="verify-btn" class="verify-btn">ØªØ­Ù‚Ù‚</button>
        <div id="message" class="error-message" style="display:none;"></div>
    </div>

<script>
    const verifyBtn = document.getElementById('verify-btn');
    const answerInput = document.getElementById('answer-input');
    const messageDiv = document.getElementById('message');
    const questionDiv = document.getElementById('challenge-question');

    let question = "";
    let attempts = 0;
    const maxAttempts = 3;
    let userAgent = navigator.userAgent;

    async function loadChallenge() {
        try {
            const res = await fetch('/api/security/generate-challenge');
            if (res.ok) {
                const data = await res.json();
                question = data.question;
                questionDiv.textContent = `Ø­Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø©: ${question}`;
                answerInput.value = "";
                messageDiv.style.display = "none";
                verifyBtn.disabled = false;
            } else {
                questionDiv.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„.";
                verifyBtn.disabled = true;
            }
        } catch {
            questionDiv.textContent = "ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„.";
            verifyBtn.disabled = true;
        }
    }

    async function verifyAnswer() {
        let answer = answerInput.value.trim();
        if (answer === "") {
            showMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©", true);
            return;
        }
        verifyBtn.disabled = true;

        try {
            const res = await fetch('/api/security/verify-human', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    answer: answer,
                    user_agent: userAgent,
                    attempts: attempts
                })
            });
            const data = await res.json();

            if (res.ok && data.success) {
                showMessage(data.message, false);
                setTimeout(() => {
                    window.location.href = '/admin/login';  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†
                }, 1500);
            } else {
                attempts++;
                if(attempts >= maxAttempts){
                    showMessage("ØªØ¬Ø§ÙˆØ²Øª Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡. Ø³ÙŠØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ø¤Ù‚ØªÙ‹Ø§.", true);
                    verifyBtn.disabled = true;
                    setTimeout(() => {
                        window.location.href = '/security/blocked';
                    }, 3000);
                } else {
                    showMessage(data.message || "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ù‹Ø§.", true);
                    await loadChallenge();
                }
            }
        } catch {
            showMessage("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¯Ø±Ø§Ø³ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.", true);
        } finally {
            verifyBtn.disabled = false;
        }
    }

    function showMessage(msg, isError) {
        messageDiv.textContent = msg;
        messageDiv.style.color = isError ? '#ff0040' : '#00ff41';
        messageDiv.style.display = 'block';
    }

    verifyBtn.addEventListener('click', verifyAnswer);
    answerInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            verifyAnswer();
        }
    });

    loadChallenge();
</script>
</body>
</html>
